# Version logic
versions:
  - criteria:
      variant: store
    script: store-script

# Install scripts
## Store
store-script:
  info:
    name: Store CRM
    icon: FaCashRegister
    color:
      r: 4
      g: 102
      b: 201
  steps:
    #- action: createModel
    #  required: true
    #  locked: false
    #  model: crm-products
    #- action: createModel
    #  required: true
    #  locked: false
    #  model: crm-orders
    - action: registerSystemValues
      values:
        people:
          types:
            - label: Customer
              key: customer
            - label: Supplier
              key: supplier
  post-install:
    - registerApp

# Data to load into the system
data:
  models:
    # Base product model
    crm-products:
      name: Product
      name_plural: Products
      app: crm
      icon: FaPeopleCarry
      indexed: true
      primary: name
      fields:
        name:
          name: Name
          required: true
          type: input
        description:
          name: Description
          required: true
          type: richtext
        quantity:
          name: Quantity
          type: input
          typeArgs:
            type: number
          default: 1
        picture:
          name: Picture
          type: picture
          typeArgs:
            asBanner: true
        price:
          name: Price
          type: input
          typeArgs:
            type: number
            numberType: currency
        sold:
          name: Sold
          type: formula
          typeArgs:
            type: number
            formula: >-
              {{ count_related('crm-orders','products',[{"field":"paid","operator":"equals","value":true}]) }}
        available:
          name: Available
          type: formula
          typeArgs:
            formula: >-
              {{ math("{quantity} - {sold}") }}
            type: number
      preview:
        enabled: true
        fields:
          - name
        picture: picture
      handlers:
        crm: /crm/products/{object:_id}
      permissions:
        read:
          - known
        create:
          - known
        modifyOwn:
          - known
        write:
          - known
        delete:
          - known
        deleteOwn:
          - known
        archive:
          - known
        archiveOwn:
          - known
      actions:
        create:
          layout: create
          type: create
      overviews:
        default:
          fields:
            - picture
            - name
            - description
            - available
          buttons:
            - create
          actions:
            - delete
      layouts:
        default:
          layout:
            - type: AnimationContainer
              xs: 12
              id: khasxdr6
              items:
                - type: GridContainer
                  xs: 12
                  id: khasxj8n
                  items:
                    - type: GridItem
                      xs: 12
                      id: khasxngg
                      md: 9
                      key: default
                      items:
                        - type: AnimationItem
                          xs: 12
                          id: khasxum6
                          items:
                            - type: Paper
                              xs: 12
                              id: khasxx1k
                              title: Product
                              withBigMargin: true
                              key: default
                              md: 9
                              items:
                                - type: Field
                                  xs: 12
                                  id: khato1rq
                                  field: name
                                  displayfields: people,price,paid
                                - type: Field
                                  xs: 12
                                  id: khato3q3
                                  field: description
                                  displayfields: people,price,paid
                                - type: Field
                                  xs: 12
                                  id: khato4v9
                                  field: quantity
                                  displayfields: people,price,paid
                                - type: Field
                                  xs: 12
                                  id: khato67v
                                  field: picture
                                  hideView: true
                                  displayfields: people,price,paid
                                - type: Field
                                  xs: 12
                                  id: khatok9q
                                  field: price
                                  hideView: true
                                  displayfields: people,price,paid
                                - type: Field
                                  xs: 12
                                  id: khatopd3
                                  field: price
                                  displayfields: people,price,paid
                    - type: GridItem
                      xs: 12
                      id: khasy8dc
                      md: 3
                      key: default
                      withBigMargin: true
                      title: Product
                      items:
                        - type: AnimationItem
                          xs: 12
                          id: khasydf2
                          items:
                            - type: RelatedList
                              xs: 12
                              id: khasymfk
                              title: Orders
                              object: crm-orders
                              field: products
                              displayfields: person,price,paid
                              valueCopyFields: price=price
                              onlyVisibleWithResults: false
                              displayCard: true
                              withBigMargin: true
                              addButton: true
                              key: default
                              md: 3
          buttons:
            - delete
            - clone
            - archive
          factsBar:
            - picture
            - name
            - available
            - sold
    # Orders
    crm-orders:
      key: crm-orders
      name: Order
      name_plural: Orders
      linked: true
      linkedModels:
        - label: Product
          value: crm-products
        - label: Person
          value: people
      primary: name
      icon: FaShoppingCart
      preview:
        fields:
          - name
          - products
          - person
          - price
        enabled: true
      handlers:
        crm: /crm/orders/{object:_id}
      permissions:
        read:
          - known
        create:
          - known
        modifyOwn:
          - known
        write:
          - known
        delete:
          - known
        deleteOwn:
          - known
        archive:
          - known
        archiveOwn:
          - known
      actions:
        create:
          layout: create
          type: create
      overviews:
        default:
          fields:
            - name
            - products
            - person
          buttons:
            - create
          actions:
            - delete
      layouts:
        default:
          layout:
            - type: AnimationContainer
              xs: 12
              id: kf2r51ws
              items:
                - type: GridContainer
                  xs: 12
                  id: kg6o8d15
                  items:
                    - type: GridItem
                      xs: 12
                      id: kg6o8fgk
                      md: 9
                      items:
                        - type: AnimationItem
                          xs: 12
                          id: kf2r5375
                          items:
                            - type: Paper
                              xs: 12
                              id: kf2r56lv
                              title: Sale
                              withBigMargin: true
                              key: default
                              items:
                                - type: Field
                                  id: 3c5meakg285qlt
                                  field: products
                                - type: Field
                                  id: 3c5meakg285qlu
                                  field: person
                                - type: Field
                                  xs: 12
                                  id: kg6mi8nq
                                  field: price
                                - type: Field
                                  xs: 12
                                  id: kganfq71
                                  field: paid
                    - type: GridItem
                      xs: 12
                      id: kg6o8nb4
                      md: 3
                      items:
                        - type: AnimationItem
                          xs: 12
                          id: kg6o9472
                          items:
                            - type: Paper
                              xs: 12
                              id: kg6o986w
                              title: Files
                              withBigMargin: true
                              md: 3
                              items:
                                - type: Attachments
                                  xs: 12
                                  id: kg6ob8qs
                                  key: receipts
                                  allowUpload: false
          buttons:
            - delete
            - document_generator-configure
        create:
          layout:
            - type: Field
              id: 3c5meakg285qlt
              field: products
            - type: Field
              id: 3c5meakg285qlu
              field: person
            - type: Field
              xs: 12
              id: kg6mgjmi
              field: price
            - type: Field
              xs: 12
              id: kganfxxg
              field: paid
          buttons: []
      fields:
        name:
          name: Name
          type: auto_name
          typeArgs:
            prefix: ORDER
            mode: increment
        products:
          name: Products
          type: relationship_m
          required: true
          typeArgs:
            relationshipTo: crm-products
        person:
          name: Person
          type: relationship
          required: true
          typeArgs:
            relationshipTo: people
        price:
          name: Price
          type: input
          typeArgs:
            type: number
            numberType: currency
        paid:
          name: Paid
          type: boolean
          default: "true"
      app: crm
      indexed: false
      extensions:
        document_generator:
          name: Document generator
          active: true
  objects:
